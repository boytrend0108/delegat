import{af as E,_ as D,o as n,c as d,d as e,t as _,K as c,p as C,h as R,ag as x,m as k,B as b,b as G,r as u,H as T,f as m,F as O,i as q,g as p,e as g,w as S,T as L,G as y,y as P,z as N}from"./index-BueGtXLM.js";const B=s=>{if(s.clipboardData){const r=s.clipboardData.items;if(r){for(let i=0;i<r.length;i++)if(r[i].type.indexOf("image")!==-1||r[i].type.indexOf("application/msword")!==-1){var t=r[i].getAsFile(),o=window.URL||window.webkitURL,l=o.createObjectURL(t);const f=t.name.split(".");E.commit("SET_UPLOAD_DATA",{href:l,id:"chat_file",site_role:"customer",name:t.name,ext:f[f.length-1]}),E.commit("SET_BINARY_FILE",{files:t,id:"chat_file"}),setTimeout(()=>window.scrollTo(0,document.body.scrollHeight),500)}}}},h=s=>(C("data-v-636b3696"),s=s(),R(),s),U={class:"form-requisites"},F={class:"form-item"},$=h(()=>e("h2",{class:"form-item__title"},"Информация о пользователе",-1)),Y={class:"form-item__box"},W=h(()=>e("p",{class:"form-item__key"},"ФИО :",-1)),z={class:"form-item__value"},K={class:"form-item__box"},j=h(()=>e("p",{class:"form-item__key"},"Email :",-1)),V={class:"form-item__value"},Q={class:"form-item__box"},J=h(()=>e("p",{class:"form-item__key"},"Телефон :",-1)),X={class:"form-item__value"},Z={class:"form-item"},ss=h(()=>e("h2",{class:"form-item__title"},"Информация о фирме ",-1)),es={class:"form-item__box"},ts=h(()=>e("p",{class:"form-item__key"},"Название фирмы:",-1)),is={class:"form-item__value"},os={class:"form-item__box"},rs=h(()=>e("p",{class:"form-item__key"},"ИНН:",-1)),as={class:"form-item__value"},ls={class:"form-item__box"},_s=h(()=>e("p",{class:"form-item__key"},"КПП :",-1)),hs={class:"form-item__value"},ns={class:"form-item__box"},cs=h(()=>e("p",{class:"form-item__key"},"ОГРН :",-1)),ds={class:"form-item__value"},ms={class:"form-item__box"},us=h(()=>e("p",{class:"form-item__key"},"Юридический адрес :",-1)),fs={class:"form-item__value"},gs={class:"form-item__box"},ps=h(()=>e("p",{class:"form-item__key"},"ОГРН :",-1)),ws={class:"form-item__value"},Es={class:"form-item__box"},Ts=h(()=>e("p",{class:"form-item__key"},"Телефон :",-1)),Ss={class:"form-item__value"},ys={class:"form-item__box"},Ds=h(()=>e("p",{class:"form-item__key"},"Email :",-1)),Cs={class:"form-item__value"},Rs={class:"form-item"},vs=h(()=>e("h2",{class:"form-item__title"},"Информация о банковском счете ",-1)),Ms={class:"form-item__box"},As=h(()=>e("p",{class:"form-item__key"},"Банк :",-1)),Hs={class:"form-item__value"},Is={class:"form-item__box"},xs=h(()=>e("p",{class:"form-item__key"},"БИК :",-1)),ks={class:"form-item__value"},bs={class:"form-item__box"},Gs=h(()=>e("p",{class:"form-item__key"},"Расчетный счет :",-1)),Os={class:"form-item__value"},qs={class:"form-item__box"},Ls=h(()=>e("p",{class:"form-item__key"},"Корресп. счет :",-1)),Ps={class:"form-item__value"},Ns={__name:"RequisitesForm",props:["requisites"],setup(s){const t=s,{user:o,firm:l,bank:r}=t.requisites;return(i,f)=>(n(),d("div",U,[e("div",F,[$,e("div",Y,[W,e("p",z,_(c(o).full_name),1)]),e("div",K,[j,e("p",V,_(c(o).email),1)]),e("div",Q,[J,e("p",X,_(c(o).phone_number),1)])]),e("div",Z,[ss,e("div",es,[ts,e("p",is,_(c(l).org_type+" "+c(l).long_name),1)]),e("div",os,[rs,e("p",as,_(c(l).inn),1)]),e("div",ls,[_s,e("p",hs,_(c(l).kpp),1)]),e("div",ns,[cs,e("p",ds,_(c(l).ogrn),1)]),e("div",ms,[us,e("p",fs,_(c(l).ogrn),1)]),e("div",gs,[ps,e("p",ws,_(c(l).ogrn),1)]),e("div",Es,[Ts,e("p",Ss,_(c(l).phone_number),1)]),e("div",ys,[Ds,e("p",Cs,_(c(l).email),1)])]),e("div",Rs,[vs,e("div",Ms,[As,e("p",Hs,_(c(r).name),1)]),e("div",Is,[xs,e("p",ks,_(c(r).bic),1)]),e("div",bs,[Gs,e("p",Os,_(c(r).ras_schet),1)]),e("div",qs,[Ls,e("p",Ps,_(c(r).kor_schet),1)])])]))}},Bs=D(Ns,[["__scopeId","data-v-636b3696"]]),Us={xmlns:"http://www.w3.org/2000/svg",width:"23",height:"26",fill:"none"},Fs=e("path",{stroke:"#416782","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15.749 7.373 5.987 17.3a1.875 1.875 0 0 0 2.649 2.649L20.273 8.147a3.75 3.75 0 0 0-5.297-5.297L3.339 14.65a5.618 5.618 0 1 0 7.945 7.946l9.621-9.598"},null,-1),$s=[Fs];function Ys(s,t){return n(),d("svg",Us,[...$s])}const Ws={render:Ys},zs={name:"chat-box2",emits:["close_dialog"],components:{MyChatMsg:x,RequisitesForm:Bs},data(){return{innerWidth:window.innerWidth,messages:[],files:[],newMessage:"",chat_id:"",boxHeight:"",error:"",page:1,page_size:300,allow:!0,lastDate:"",dateNow:"",clipboard:"",offer_id:this.$route.query.offer_id,msgClientY:0,messageHeight:null,isGuest:null,selectedMsg:null,showSelectedMsg:!1,showDownBtn:!1,replyTo:0,messageAuthorName:"",requisites:null,showDialog:!1,showPreloader:!1,showContextMenu:!1,showRequisitesForm:!1}},computed:{...k(["SPECIFIC_OFFER","CURRENT_USER","CHAT_HISTORY","SELECTED_ORDER","DOCS","CHAT_ID","INNER_WIDTH","SITE_ROLE","DIALOG","BIG_IMG_CHAT","CHAT_PAGE","NEW_MSG","TECH_MSG","IS_CHAT_CLOSED","IS_MSG_READ","USER_BY_ID","USER_NAME"]),showGetRequisitesBtn(){return this.showWarningMsg?!1:this.SITE_ROLE==="provider"&&this.$route.query.status==="IN_PROGRESS"},top(){return this.msgClientY+this.messageHeight},positionTop(){if(!(window.innerWidth>600))return this.$route.name==="customer-chat"&&this.$route.query.status==="PUBLISHED"?194:100},showTextArea(){var s;return this.$route.query.status==="COMPLETED"?!1:this.SITE_ROLE==="customer"?!0:!(this.$route.query.status==="IN_PROGRESS"&&((s=this.CURRENT_USER)==null?void 0:s.uid)!==this.SELECTED_ORDER.provider_id)},showWarningMsg(){var s;return this.$route.query.status==="COMPLETED"||this.SITE_ROLE==="customer"?!1:this.$route.query.status==="IN_PROGRESS"&&((s=this.CURRENT_USER)==null?void 0:s.uid)!==this.SELECTED_ORDER.provider_id},filteredMesages(){let s;switch(this.SITE_ROLE){case"customer":return s=this.messages.filter(t=>{var o;return!((o=t.body)!=null&&o.includes("Вас выбрали исполнителем"))}),this.SET_FILTERED_MESSAGES(s),s;case"provider":return s=this.messages.filter(t=>{var o;return!((o=t.body)!=null&&o.includes("Вы выбрали исполнителя"))}),this.SET_FILTERED_MESSAGES(s),s;default:return this.messages}}},methods:{...b(["SELECT_PROVIDER","CREATE_SOCKET","GET_CHAT_HISTORY","UPLOAD_DOCS","GET_CHAT_ID","SEND_MSG","UPLOAD_DOCS_DRAG","READ_MSG","GET_REQUISITES"]),...G(["SET_CHAT_PAGE","SET_CHAT_ID","SET_FILTERED_MESSAGES"]),async dowloadHistory(s){this.SET_CHAT_PAGE(0),this.messages=[],this.page_size=s.id+30,await this.getChatHistory(),this.page_size=300,setTimeout(()=>s.currentElem.click(),1e3)},async getChatHistory(){this.showPreloader=!0,await this.GET_CHAT_HISTORY({order_id:this.$route.params.id,offer_id:this.$route.query.offer_id,page_size:this.page_size}).then(()=>{this.$refs.messages.style.overflowY="hidden",this.showPreloader=!1,this.messages=this.CHAT_HISTORY.reverse(),this.chat_id=this.messages[0].chat_id}).then(()=>{var s;this.setLastDate(),this.$refs.messages.scrollTop=(s=this.$refs.messages)==null?void 0:s.scrollHeight,this.SET_CHAT_PAGE(this.CHAT_PAGE+1),this.$refs.messages.style.overflowY="scroll"})},changeChat(){this.watcher=!1,this.SET_CHAT_PAGE(0),this.page=1,this.messages=[],this.getChatHistory()},intersection(){var t,o,l;((t=this.$refs.messages)==null?void 0:t.scrollTop)<((o=this.$refs.messages)==null?void 0:o.scrollHeight)/1.3?this.showDownBtn=!0:this.showDownBtn=!1;const s={order_id:this.$route.params.id,offer_id:this.$route.query.offer_id,page:this.CHAT_PAGE,page_size:this.page_size};if((l=this.$refs.messages)!=null&&l.scrollTop&&this.$refs.messages.scrollTop>700&&this.$refs.messages.scrollTop<1200){if(this.CHAT_PAGE!==this.page)return;this.page++,this.$refs.messages.removeEventListener("scroll",this.intersection),this.GET_CHAT_HISTORY(s).then(()=>{this.CHAT_HISTORY.length&&(this.messages=[...this.CHAT_HISTORY.reverse(),...this.messages],this.$refs.messages.scrollTop=1600,setTimeout(()=>{this.$refs.messages.addEventListener("scroll",this.intersection)},600))})}},checkDate(){if(!this.newMessage.length&&!this.DOCS.images.binaryFile.length)return;const s={chat_id:this.CHAT_ID,body:this.newMessage,reply_to:Number(this.replyTo)||0},t={chat_id:this.CHAT_ID,body:this.dateNow,id_date:!0};(()=>{this.dateNow===this.lastDate?this.sendMsg(s):this.sendMsg(t).then(()=>this.sendMsg(s))})(),this.showSelectedMsg=!1,this.selectedMsg=null},async sendMsg(s){return this.showPreloader=!0,this.SEND_MSG(s).then(()=>{this.newMessage="",this.$refs.messages.scrollTop=this.$refs.messages.scrollHeight,this.$refs.textarea.style.height="5rem",this.showPreloader=!1,this.setLastDate(),this.replyTo=0}).catch(t=>{this.error=t,this.showPreloader=!1})},setLastDate(){const s=this.messages[this.messages.length-1].created_at;this.lastDate=s.split("T")[0].slice(5,10)},setTime(s){const t=new Date(s);let o=t.getMinutes();return o.toString().length===1&&(o="0"+o),`${t.getHours()}:${o}`},playSound(s){const t=s.split("-")[0]==="c"?"customer":"provider";if(localStorage.getItem("site_role")===t)return;const o=new Audio;o.src=require("@/assets/sound/iphone.wav"),o.play()},closeDialog(){setTimeout(()=>{this.showRequisitesForm=!1,this.showDialog=!1,this.error=""},500)},showDialogFn(){this.showDialog=!0},setSelectedMessage(s){if(this.showSelectedMsg=!0,this.selectedMsg=s,this.replyTo=s.id,this.CURRENT_USER.uid===this.selectedMsg.user_id)this.messageAuthorName=this.CURRENT_USER.full_name;else switch(this.SITE_ROLE){case"provider":this.messageAuthorName=this.USER_BY_ID.full_name;break;case"customer":this.messageAuthorName=this.SPECIFIC_OFFER.owner_name}},scrollChatDown(){const s=this.$refs.messages;setTimeout(()=>{s==null||s.scrollTo({top:s.scrollHeight,behavior:"smooth"}),this.showDownBtn=!1})},showContext(s){this.showDownBtn=!1,this.msgClientY=s.clientY,this.messageHeight=s.height,this.isGuest=s.isGuest,this.showContextMenu=!this.showContextMenu,this.selectedMsg=s.msg},hideMessageReplyBox(){this.selectedMsg=null,this.showSelectedMsg=!1},paste(s){this.clipboard=B(s)},async uploadDocs(s){this.UPLOAD_DOCS(s).then(()=>{window.scrollTo(0,window.innerHeight)})},handlerKeypress(s){!s.shiftKey&&s.code==="Enter"&&this.checkDate(),s.key==="Backspace"&&(window.scrollTo(0,document.body.scrollHeight+100),this.$refs.textarea.style.height="auto"),s.shiftKey&&s.code==="Enter"&&(this.$refs.textarea.style.height=`${this.$refs.textarea.scrollHeight}px`,window.scrollTo(0,document.body.scrollHeight+100))},adjustHeight2(){const s=document.querySelector(".chatBox").clientHeight;window.innerWidth>600?this.boxHeight=s*.8:this.boxHeight=s*.9},allowDrop(s){s.preventDefault()},drop(s){s.preventDefault(),this.UPLOAD_DOCS_DRAG(s)},hideKeyboard(){window.innerWidth<600&&window.scrollTo(0,0)},async getRequisites(){try{this.requisites=await this.GET_REQUISITES(this.$route.params.id),this.showRequisitesForm=!0,this.showDialog=!0,console.log(this.requisites)}catch(s){this.error=s,this.showDialog=!0,console.log(this.requisites)}}},watch:{DOCS:{handler(s){s.chat_file.name&&this.files.push(s.chat_file.name)},deep:!0},CHAT_ID(){this.CHAT_PAGE<1||(console.log("watcher"),this.changeChat())},NEW_MSG(){this.messages.push(this.NEW_MSG),setTimeout(()=>{this.$refs.messages.scrollTop=this.$refs.messages.scrollHeight,this.playSound(this.NEW_MSG.user_id)},500)},IS_MSG_READ(){const s=this.messages.findIndex(t=>t.id==this.IS_MSG_READ);this.messages[s].is_view=!0}},async mounted(){var o;const s={order_id:this.$route.params.id,offer_id:this.$route.query.offer_id};this.SET_CHAT_PAGE(0),this.GET_CHAT_ID(s);const t=new Date;this.dateNow=t.toISOString().split("T")[0].slice(5,10),this.showPreloader=!0,this.adjustHeight2(),await this.GET_CHAT_HISTORY({...s,page_size:this.page_size}),this.messages=this.CHAT_HISTORY.reverse(),this.setLastDate(),setTimeout(()=>{const l=this.$refs.messages;l==null||l.addEventListener("scroll",this.intersection)},4e3),this.showPreloader=!1,this.chatScrollTop=((o=this.$refs.messages)==null?void 0:o.scrollTop)-1e3,setTimeout(()=>this.scrollChatDown(),1e3)},unmounted(){this.SET_CHAT_ID(null)}},Ks=s=>(C("data-v-6b981f53"),s=s(),R(),s),js={class:"massages__box",ref:"messages",id:"scrollArea"},Vs={key:0,class:"error"},Qs={key:1,class:"messageReply"},Js={class:"messageReply__wr"},Xs={class:"messageReply__data"},Zs={class:"author"},se={class:"context__item"},ee={key:2,class:"newMsgBox"},te=Ks(()=>e("label",{for:"chat_file",class:"download-box"},[e("img",{src:Ws,alt:"Загрузить",class:"clip"})],-1)),ie={class:"sendMsgBtn"},oe=["src"],re={key:3,class:"warningMsg"},ae={key:4,class:"orderClosed"},le=["src"],_e={key:2,class:"error-msg"};function he(s,t,o,l,r,i){const f=u("my-chat-msg"),w=u("font-awesome-icon"),v=u("my-uploaded-foto"),M=u("RequisitesForm"),A=u("my-dialog"),H=u("my-big-spinner");return n(),d("div",{class:"chatBox",style:y({top:i.positionTop+"px"})},[e("div",{class:"messages",style:y({position:r.showContextMenu?"static":"relative"}),ref:"wrapper"},[i.showGetRequisitesBtn?(n(),d("button",{key:0,class:"reqisites",onClick:t[0]||(t[0]=T((...a)=>i.getRequisites&&i.getRequisites(...a),["self"]))},"Получить реквизиты ")):m("",!0),e("div",js,[(n(!0),d(O,null,q(i.filteredMesages,(a,I)=>(n(),p(f,{key:I,msg:a,time:i.setTime(a.created_at),onShowContext:i.showContext,onScrollDown:i.scrollChatDown,onShowSelectedMsg:i.setSelectedMessage,onDowloadHistory:i.dowloadHistory,onShowDialog:i.showDialogFn},null,8,["msg","time","onShowContext","onScrollDown","onShowSelectedMsg","onDowloadHistory","onShowDialog"]))),128))],512),g(L,{name:"down"},{default:S(()=>[r.showDownBtn?(n(),d("button",{key:0,class:"downBtn",onClick:t[1]||(t[1]=(...a)=>i.scrollChatDown&&i.scrollChatDown(...a))},[g(w,{icon:["fas","angles-down"],style:{color:"#f5f5f5"}})])):m("",!0)]),_:1})],4),r.error?(n(),d("p",Vs,_(r.error),1)):m("",!0),r.showSelectedMsg?(n(),d("div",Qs,[e("div",Js,[g(w,{icon:["fas","reply"],style:{color:"#ebeff4"},"data-action":"reply"}),e("div",Xs,[e("div",Zs,_(r.messageAuthorName),1),e("div",se,_(`${r.selectedMsg.body.substring(0,40)}...`),1)]),g(w,{icon:"fa-solid fa-xmark ",id:"xmark",onClick:i.hideMessageReplyBox},null,8,["onClick"])])])):m("",!0),i.showTextArea?(n(),d("div",ee,[te,e("input",{type:"file",id:"chat_file",class:"input",multiple:"true",onChange:t[2]||(t[2]=(...a)=>i.uploadDocs&&i.uploadDocs(...a))},null,32),P(e("textarea",{id:"chat_file",name:"new-message",class:"new-message","onUpdate:modelValue":t[3]||(t[3]=a=>r.newMessage=a),ref:"textarea",onKeydown:t[4]||(t[4]=(...a)=>i.handlerKeypress&&i.handlerKeypress(...a)),onDrop:t[5]||(t[5]=T((...a)=>i.drop&&i.drop(...a),["prevent"])),onDragover:t[6]||(t[6]=(...a)=>i.allowDrop&&i.allowDrop(...a)),onBlur:t[7]||(t[7]=(...a)=>i.hideKeyboard&&i.hideKeyboard(...a)),onPaste:t[8]||(t[8]=(...a)=>i.paste&&i.paste(...a))},null,544),[[N,r.newMessage,void 0,{trim:!0}]]),e("div",ie,[e("img",{src:require("@/assets/images/icons/sendMsg.svg"),alt:"send message",class:"arrow",onClick:t[9]||(t[9]=(...a)=>i.checkDate&&i.checkDate(...a))},null,8,oe)])])):m("",!0),g(v),i.showWarningMsg?(n(),d("p",re," Заказчик уже выбрал Исполнителя. В случае отказа от Исполнителя у Вас вновь появится возможность общаться в этом чате ")):m("",!0),s.$route.query.status==="COMPLETED"?(n(),d("p",ae,"Заявка закрыта")):m("",!0),r.showDialog?(n(),p(A,{key:5,onClose_dialog:i.closeDialog},{default:S(()=>[s.BIG_IMG_CHAT?(n(),d("img",{key:0,src:s.BIG_IMG_CHAT,class:"big-image"},null,8,le)):m("",!0),r.showRequisitesForm?(n(),p(M,{key:1,requisites:r.requisites},null,8,["requisites"])):m("",!0),r.error?(n(),d("div",_e,_(r.error),1)):m("",!0)]),_:1},8,["onClose_dialog"])):m("",!0),r.showPreloader?(n(),p(H,{key:6})):m("",!0)],4)}const ce=D(zs,[["render",he],["__scopeId","data-v-6b981f53"]]);export{ce as C};
